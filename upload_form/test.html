
<script async type="text/javascript" src="../out/filecheck.js"></script>
<script type="text/javascript">
    function uploaded() {
        console.log("hello");
        var uploadform = document.getElementById("fileuploadform");
        var filename = uploadform.files[0].name;
        console.log(uploadform.files[0]);
        var fr = new FileReader();

        fr.onload = function (){
            // console.log(fr.data);
            // console.log(fr.result);
            // console.log("atob", atob(fr.result.split(",")[1]));
            var stl_name = filename;

            var data = atob(fr.result.split(",")[1]);

            var intArray = new Int32Array([0, -1, -1, -1, -1, -1 ,-1]);
            function _arrayToHeap(typedArray){
                var numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
                var ptr = Module._malloc(numBytes);
                var heapBytes = new Uint8Array(Module.HEAPU8.buffer, ptr, numBytes);
                heapBytes.set(new Uint8Array(typedArray.buffer));
                return heapBytes;
            }
            var heapBytes = _arrayToHeap(intArray);

            Module['FS_createDataFile'](".", stl_name, data, true, true);
            Module.ccall("file_check", undefined, ["string", "number"], [stl_name, heapBytes.byteOffset]);

            // TODO: if you use allow_memory_grow when compile the js code, the int array's first memory location will changed! thus it will look like the result is not set!
            var result = new Int32Array(heapBytes.buffer, heapBytes.byteOffset, intArray.length);

            console.log(heapBytes.buffer, heapBytes.byteOffset, intArray.length);
            console.log(result);

            set_color(0, "green");
            get_no_degen_faces_string(result[1]);
            set_color(1, "green");
            get_no_dup_faces_string(result[2]);
            if (result[3] === 1) set_color(2, "green");
            if (result[4] === 1) set_color(3, "green");
            if (result[5] === 1) set_color(4, "green");

            function _freeArray(heapBytes){
                Module._free(heapBytes.byteOffset);
            }

            // _freeArray(heapBytes);
        };

        fr.onloadstart = set_color_all_red;

        fr.readAsDataURL(uploadform.files[0]);

        console.log(fr);

    }


    function get_no_degen_faces_string(no_degen_faces) {
        document.getElementById("numDegenFaces").innerHTML = `removed ${no_degen_faces} degenerate faces`;
    }

    function get_no_dup_faces_string(no_dup_faces) {
        document.getElementById("numDupFaces").innerHTML = `removed ${no_dup_faces} duplicate faces`;
    }

    function set_color(number, color) {
        var res = document.getElementsByClassName("condition");
        document.getElementById("condition" + number).style.backgroundColor = color;
    }

    function set_color_all_red() {
        var res = document.getElementsByClassName("condition");
        for (var i=0;i<res.length;i++) {
            document.getElementById("condition" + i).style.backgroundColor = "red";
        }
    }

    function init() {
        get_no_degen_faces_string(0);
        get_no_dup_faces_string(0);
    }

</script>

<html>
<head>
<style>

#content {
    width: 300px;
}
.condition {
    width: 100px;
    height: 70px;
    background-color: grey;
}
.container {
    width: 220px;
    height: 70px;
    display: inline-block;
    margin: 1px;
}

.arrow {
    border: solid black;
    border-width: 0 3px 3px 0;
    display: inline-block;
    padding: 3px;
}

.a_down {
    transform: rotate(45deg);
    -webkit-transform: rotate(45deg);
}

.a_right {
    transform: rotate(-45deg);
    -webkit-transform: rotate(-45deg);
    margin-top:20px;
}

.a_left {
    transform: rotate(135deg);
    -webkit-transform: rotate(135deg);
    margin-top:15px;
    margin-left:4px;
}

.left {
    float: left;
}
.right {
    float: right;
}

.downArrowContainer {
    height: 15px;
    margin-bottom: 5px;
    margin-top: 5px;
    margin-left: 45px;
}

.rightArrowContainer {
    width: 15px;
    height: 70px; /* inherit from container */
    float: left;
}

</style>
</head>
<input type="file" onChange="uploaded()" id="fileuploadform"/>

<body onload="init()">
    <div id="content">
        <div class="container">
            <div id="condition0" class="condition left"><p>No Dengenerated Faces</p></div>
            <div class="rightArrowContainer">
                <i class="arrow a_right"></i>
                <i class="arrow a_left"></i>
            </div>
            <div id="repair0" class="condition right"><p id="numDegenFaces"></p></div>
        </div>

        <div class="downArrowContainer">
            <i class="arrow a_down"></i>
        </div>

        <div class="container">
            <div id="condition1" class="condition left"><p>No Duplicate Faces</p></div>
            <div class="rightArrowContainer">
                <i class="arrow a_right"></i>
                <i class="arrow a_left"></i>
            </div>
            <div id="repair1" class="condition right"><p id="numDupFaces"></p></div>
        </div>

        <div class="downArrowContainer">
            <i class="arrow a_down"></i>
        </div>

        <div class="container">
            <div id="condition2" class="condition left"><p>is manifold</p></div>
        </div>

        <div class="downArrowContainer">
            <i class="arrow a_down"></i>
        </div>

        <div class="container">
            <div id="condition3" class="condition left"><p>is consistent normal</p></div>
        <div class="rightArrowContainer">
            <i class="arrow a_right"></i>
            <i class="arrow a_left"></i>
        </div>
            <div id="repair3" class="condition right"><p>fix consistent normal</p></div>
        </div>
        <!--<i class="arrow a_down"></i>-->

        <div class="downArrowContainer">
            <i class="arrow a_down"></i>
        </div>

        <div class="container">
            <div id="condition4" class="condition left"><p>is volume bigger 0</p></div>
        <div class="rightArrowContainer">
            <i class="arrow a_right"></i>
            <i class="arrow a_left"></i>
        </div>
            <div id="repair4" class="condition right"><p>fix volume</p></div>
        </div>
    </div>
</body>
</html>
